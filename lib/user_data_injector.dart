import 'package:cotor/features/Request/request_bloc/request_bloc.dart';
import 'package:cotor/features/authentication/authentication.dart';
import 'package:cotor/features/edit_tutee_assignment/bloc/edit_tutee_assignment_bloc.dart';
import 'package:cotor/features/edit_tutor_profile/bloc/edit_tutor_profile_bloc.dart';
import 'package:cotor/features/request_tutor/request_tutor_form/bloc/request_tutor_form_bloc.dart';
import 'package:cotor/features/request_tutor/select_existing_assignment/bloc/select_existing_assignment_bloc.dart';
import 'package:cotor/features/select_profile_image/select_profile_image_export.dart';
import 'package:cotor/features/user_profile_bloc/user_profile_bloc.dart';
import 'package:cotor/features/view_assignment/bloc/view_assignment_bloc.dart';
import 'package:cotor/features/view_tutor_profile/bloc/view_tutor_profile_bloc.dart';
import 'package:cotor/injection_container.dart';
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';

/// Used to create user-dependent objects that need to be accessible by all widgets.
/// This widgets should live above the [MaterialApp].
/// See [InitialPageDecider], a descendant widget that consumes the snapshot generated by this builder.
class UserDataInjector extends StatelessWidget {
  const UserDataInjector({
    Key key,
    @required this.builder,
  }) : super(key: key);
  final Widget Function(BuildContext, AuthenticationState) builder;

  @override
  Widget build(BuildContext context) {
    return BlocBuilder<AuthenticationBloc, AuthenticationState>(
      builder: (context, state) {
        if (state is Authenticated) {
          return MultiBlocProvider(providers: [
            BlocProvider<UserProfileBloc>(
              create: (context) => sl<UserProfileBloc>()
                ..add(UserEnterHompage(uid: state.userProfile.uid)),
            ),
            BlocProvider(
              create: (context) => sl<RequestBloc>()
                ..add(InitialiseRequestBloc(uid: state.userProfile.uid)),
            ),
            BlocProvider<ViewAssignmentBloc>(
              create: (context) => sl<ViewAssignmentBloc>(),
            ),
            BlocProvider<ViewTutorProfileBloc>(
              create: (context) => sl<ViewTutorProfileBloc>(),
            ),
            BlocProvider<EditTutorProfileBloc>(
              create: (context) => sl<EditTutorProfileBloc>(),
            ),
            BlocProvider<EditTuteeAssignmentBloc>(
              create: (context) => sl<EditTuteeAssignmentBloc>(),
            ),
            BlocProvider<SelectExistingAssignmentBloc>(
              create: (context) => sl<SelectExistingAssignmentBloc>(),
            ),
            BlocProvider<RequestTutorFormBloc>(
              create: (context) => sl<RequestTutorFormBloc>(),
            ),
            BlocProvider(
              create: (context) => sl<UploadProfileImageBloc>(),
              child: Container(),
            )
          ], child: builder(context, state));
        } else {
          return builder(context, state);
        }
      },
    );
  }
}
